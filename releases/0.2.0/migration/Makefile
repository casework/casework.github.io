#!/usr/bin/make -f

# This software was developed at the National Institute of Standards
# and Technology by employees of the Federal Government in the course
# of their official duties. Pursuant to title 17 Section 105 of the
# United States Code this software is not subject to copyright
# protection and is in the public domain. NIST assumes no
# responsibility whatsoever for its use by other parties, and makes
# no guarantees, expressed or implied, about its quality,
# reliability, or any other characteristic.
#
# We would appreciate acknowledgement if the software is used.

SHELL := /bin/bash

top_srcdir := $(shell cd ../../.. ; pwd)

all: \
  classes_ambiguous.csv \
  classes.csv \
  kindOfRelationship_enumerants.csv \
  properties_ambiguous.csv \
  properties.csv

.PRECIOUS: \
  %.csv \
  %.tsv

# The '.check-...' pattern rules independently re-create the visible file, for comparison up through the Git-tracked state.
.check-%.csv: \
  %.tsv
	cat $< \
	  | tr '\t' ',' \
	    > _$@
	mv _$@ $@

.check-%.tsv: \
  $(top_srcdir)/_data/releases/migration_0_2_0/%.tsv
	cp $< _$@
	mv _$@ $@

%.csv: \
  %.tsv
	cat $< \
	  | tr '\t' ',' \
	    > _$@
	mv _$@ $@

%.tsv: \
  $(top_srcdir)/_data/releases/migration_0_2_0/%.tsv
	cp $< _$@
	mv _$@ $@

# NOTE: This recipe uses two similar-looking Make automatic variables, $^ and $<.
# https://www.gnu.org/software/make/manual/html_node/Automatic-Variables.html
# This recipe fails if a difference is reported.  (This is the normal behavior of the 'diff' command - a difference makes diff's exit status 1.)
%.diff: \
  % \
  .check-%
	diff $^ \
	  > _$@ \
	  || (echo "ERROR:Makefile:The file '$<' needs to be regenerated by running 'make' and committing the update." >&2 ; exit 1)
	@# Having tested the re-created file, next test against the Git-tracked state as well.
	test 1 -eq $$(git ls-tree HEAD $< | wc -l)  # Confirm file is git-tracked.
	git diff $< > _$@
	@# Confirm file exists, but is empty.
	test -e _$@ && test ! -s _$@ \
	  || (echo "ERROR:Makefile:The regenerated file '$<' needs to be committed." >&2 ; exit 1)
	mv _$@ $@

# The unit test of this directory is:
# * Confirm that the TSV files in this directory match the files used to power the Jekyll-generated page.
# * Confirm that the CSV and TSV files in this directory match the Git-tracked state.
# The .diff files should not be retained.  If any are found after calling 'make check', they illustrate a problem.
check: \
  classes_ambiguous.csv.diff \
  classes_ambiguous.tsv.diff \
  classes.csv.diff \
  classes.tsv.diff \
  kindOfRelationship_enumerants.csv.diff \
  kindOfRelationship_enumerants.tsv.diff \
  properties_ambiguous.csv.diff \
  properties_ambiguous.tsv.diff \
  properties.csv.diff \
  properties.tsv.diff
	rm *.diff

clean:
	@rm -f *.csv *.diff *.tsv _*
