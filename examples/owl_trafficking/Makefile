#!/usr/bin/make -f

# This software was developed at the National Institute of Standards
# and Technology by employees of the Federal Government in the course
# of their official duties. Pursuant to title 17 Section 105 of the
# United States Code this software is not subject to copyright
# protection and is in the public domain. NIST assumes no
# responsibility whatsoever for its use by other parties, and makes
# no guarantees, expressed or implied, about its quality,
# reliability, or any other characteristic.
#
# We would appreciate acknowledgement if the software is used.

SHELL := /bin/bash

PYTHON3 ?= $(shell which python3)

top_srcdir := $(shell cd ../.. ; pwd)

all: \
  index.html \
  owl_trafficking.json

# Tests:
# * Confirm JSON portions of example are not changed when run through json.tool.
# * Confirm the Git-committed version of owl_trafficking.json matches the file generated from the JSON pieces.
# * Confirm the Git-committed version of index.html matches the file generated from index.html.in and the JSON pieces.
# The .diff files should not be retained.  If any are found after calling 'make check', they illustrate a problem.
check: \
  owl_trafficking.json.diff \
  owl_trafficking_0.json.diff \
  owl_trafficking_1.json.diff \
  owl_trafficking_2.json.diff \
  owl_trafficking_3.json.diff \
  owl_trafficking_4.json.diff \
  owl_trafficking_5.json.diff \
  owl_trafficking_6.json.diff \
  owl_trafficking_7.json.diff \
  owl_trafficking_8.json.diff \
  owl_trafficking_9.json.diff \
  owl_trafficking_10.json.diff \
  owl_trafficking_11.json.diff \
  owl_trafficking_12.json.diff \
  owl_trafficking_13.json.diff \
  owl_trafficking_14.json.diff \
  owl_trafficking_15.json.diff \
  owl_trafficking_16.json.diff \
  owl_trafficking_17.json.diff \
  owl_trafficking_18.json.diff \
  owl_trafficking_19.json.diff \
  index.html.diff
	rm -f $^

clean:
	@rm -f \
	  *.diff \
	  owl_trafficking.json \
	  owl_trafficking.sed \
	  index.html

# Using example from the documentation-generating Makefile at:
# https://github.com/usnistgov/swid-autotools
index.html: \
  index.html.in \
  owl_trafficking.sed \
  owl_trafficking_0.json \
  owl_trafficking_1.json \
  owl_trafficking_2.json \
  owl_trafficking_3.json \
  owl_trafficking_4.json \
  owl_trafficking_5.json \
  owl_trafficking_6.json \
  owl_trafficking_7.json \
  owl_trafficking_8.json \
  owl_trafficking_9.json \
  owl_trafficking_10.json \
  owl_trafficking_11.json \
  owl_trafficking_12.json \
  owl_trafficking_13.json \
  owl_trafficking_14.json \
  owl_trafficking_15.json \
  owl_trafficking_16.json \
  owl_trafficking_17.json \
  owl_trafficking_18.json \
  owl_trafficking_19.json \
  owl_trafficking-query-imaging_action.html
	rm -f $@_
	sed \
	  -f owl_trafficking.sed \
	  index.html.in \
	  > $@_
	mv $@_ $@

index.html.diff: \
  index.html
	test 1 -eq $$(git ls-tree HEAD $< | wc -l)  # Confirm HTML file is git-tracked.
	git diff $< > _$@
	@# Confirm patch file exists, but is empty.
	test -e _$@ && test ! -s _$@ \
	  || (echo "ERROR:examples/owl_trafficking/Makefile:The file '$<' needs to be regenerated by running with 'make' and committing the update." >&2 ; exit 1)
	mv _$@ $@

owl_trafficking.json: \
  owl_trafficking_json.py \
  owl_trafficking_0.json \
  owl_trafficking_1.json \
  owl_trafficking_2.json \
  owl_trafficking_3.json \
  owl_trafficking_4.json \
  owl_trafficking_5.json \
  owl_trafficking_6.json \
  owl_trafficking_7.json \
  owl_trafficking_8.json \
  owl_trafficking_9.json \
  owl_trafficking_10.json \
  owl_trafficking_11.json \
  owl_trafficking_12.json \
  owl_trafficking_13.json \
  owl_trafficking_14.json \
  owl_trafficking_15.json \
  owl_trafficking_16.json \
  owl_trafficking_17.json \
  owl_trafficking_18.json \
  owl_trafficking_19.json
	rm -f __$@ _$@
	$(PYTHON3) $^ > __$@
	$(PYTHON3) -m json.tool __$@ > _$@
	rm __$@
	mv _$@ $@

owl_trafficking.json.diff: \
  owl_trafficking.json
	test 1 -eq $$(git ls-tree HEAD $< | wc -l)  # Confirm JSON-LD file is git-tracked.
	git diff $< > _$@
	@# Confirm patch file exists, but is empty.
	test -e _$@ && test ! -s _$@ \
	  || (echo "ERROR:examples/owl_trafficking/Makefile:The file '$<' needs to be regenerated by running with 'make' and committing the update." >&2 ; exit 1)
	mv _$@ $@

owl_trafficking.sed:
	for x in $$(seq 0 19) ; do \
	  echo "/@OWL_TRAFFICKING_$${x}__JSON@/r owl_trafficking_$${x}.json" ; \
	  echo "/@OWL_TRAFFICKING_$${x}__JSON@/d" ; \
	done > _$@
	for x in IMAGING_ACTION ; do \
	  echo "/@QUERY_$${x}_SPARQL@/r owl_trafficking-query-$$(echo $${x} | tr '[:upper:]' '[:lower:]').sparql" ; \
	  echo "/@QUERY_$${x}_SPARQL@/d" ; \
	  echo "/@QUERY_$${x}_HTML@/r owl_trafficking-query-$$(echo $${x} | tr '[:upper:]' '[:lower:]').html" ; \
	  echo "/@QUERY_$${x}_HTML@/d" ; \
	done >> _$@
	mv _$@ $@

owl_trafficking_%.json.diff: \
  owl_trafficking_%.json
	diff \
	  $< \
	  <($(PYTHON3) -m json.tool $<) \
	  > _$@ \
	  || (echo "ERROR:examples/owl_trafficking/Makefile:The file '$<' has not had its whitespace normalized with json.tool.  Please run 'python3 -m json.tool $<' to adjust the file's whitespace." >&2 ; exit 1)
	mv _$@ $@

owl_trafficking-query-%.html: \
  owl_trafficking-query-%.sparql \
  $(top_srcdir)/.venv.done.log \
  $(top_srcdir)/src/sample_sparql_runner.py \
  owl_trafficking.json
	source $(top_srcdir)/venv/bin/activate \
	  && python3 $(top_srcdir)/src/sample_sparql_runner.py \
	    owl_trafficking.json \
	    $< \
	    _$@
	mv _$@ $@
